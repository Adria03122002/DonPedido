<div class="tpv-container animate-in">
  
  <!-- LADO IZQUIERDO: CAT√ÅLOGO DE PRODUCTOS -->
  <main class="menu-section">
    <header class="menu-header">
      <div class="header-top">
        <button (click)="volver()" class="btn-back" title="Volver">‚¨ÖÔ∏è</button>
        <div>
          <h1>{{ esNuevo ? 'Nueva' : 'Modificar' }} <span class="accent">Comanda</span></h1>
          <p class="subtitle">Gestiona los productos de la cuenta</p>
        </div>
      </div>

      <nav class="category-bar custom-scroll">
        <button 
          *ngFor="let cat of categorias" 
          (click)="setCategoria(cat)" 
          class="category-chip"
          [class.active]="categoriaActiva === cat">
          {{ cat }}
        </button>
      </nav>
    </header>

    <div class="products-grid custom-scroll">
      <div *ngFor="let prod of productosFiltrados" 
           (click)="agregarProducto(prod)"
           class="product-card animate-slide-in">
        
        <!-- BOT√ìN DE INFORMACI√ìN (Ficha T√©cnica) -->
        <button class="btn-info-circle" (click)="verInfo($event, prod)" title="Ver ingredientes">i</button>

        <div class="icon-wrapper">
          <img *ngIf="prod.imagenUrl" 
               [src]="prod.imagenUrl" 
               [alt]="prod.nombre" 
               class="product-img"
               onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
          
          <span class="fallback-emoji" style="display: none;">
            {{ getEmoji(prod.tipo) }}
          </span>

          <span *ngIf="!prod.imagenUrl" class="fallback-emoji">
            {{ getEmoji(prod.tipo) }}
          </span>
        </div>

        <div class="product-info">
          <h3 class="name">{{ prod.nombre }}</h3>
          <span class="price">{{ prod.precio | currency:'EUR' }}</span>
        </div>
        
        <div class="plus-indicator">+</div>
      </div>

      <div *ngIf="productosFiltrados.length === 0" class="empty-cat">
        <p>No hay productos en {{ categoriaActiva }}</p>
      </div>
    </div>
  </main>

  <!-- LADO DERECHO: TICKET -->
  <aside class="ticket-section">
    <header class="ticket-header">
      <div class="customer-info">
        <div class="avatar-mesa">üìç</div>
        <div class="details">
          <span class="badge">Mesa / Ubicaci√≥n</span>
          <h2>{{ ubicacion }}</h2>
          <p class="client-name">{{ nombreCliente || 'Cliente General' }}</p>
        </div>
      </div>
      <div *ngIf="pedidoId" class="order-id">#{{ pedidoId }}</div>
    </header>

    <div class="ticket-items custom-scroll">
      <div *ngIf="lineasPedido.length === 0" class="empty-state">
        <span class="empty-icon">üìù</span>
        <p>El ticket est√° vac√≠o</p>
      </div>

      <div *ngFor="let linea of lineasPedido; let i = index" class="linea-item animate-slide-in">
        <div class="item-main">
          <div class="item-thumb">
            <img *ngIf="linea.producto.imagenUrl" [src]="linea.producto.imagenUrl" class="thumb-img">
            <span *ngIf="!linea.producto.imagenUrl">{{ getEmoji(linea.producto.tipo) }}</span>
          </div>

          <div class="item-info">
            <span class="title">{{ linea.producto.nombre }}</span>
            <span class="subtotal">{{ (linea.cantidad * (linea.producto.precio || 0)) | currency:'EUR' }}</span>
          </div>
          
          <div class="qty-controls">
            <button (click)="cambiarCantidad(i, -1)" class="btn-qty minus">Ôºç</button>
            <span class="qty-val">{{ linea.cantidad }}</span>
            <button (click)="cambiarCantidad(i, 1)" class="btn-qty plus">Ôºã</button>
          </div>
        </div>
        
        <div class="item-footer">
          <div class="note-wrapper">
            <span class="note-icon">üìù</span>
            <input [(ngModel)]="linea.modificacion" 
                   placeholder="Notas (sin cebolla, muy hecho...)" 
                   class="item-note">
          </div>
          <button (click)="eliminarLinea(i)" class="btn-remove" title="Eliminar plato">‚úñ</button>
        </div>
      </div>
    </div>

    <footer class="ticket-footer">
      <div class="total-row">
        <span class="total-label">Importe Total</span>
        <span class="total-amount">{{ calcularTotal() | currency:'EUR' }}</span>
      </div>

      <button (click)="guardar()" 
              [disabled]="lineasPedido.length === 0"
              class="btn-submit"
              [class.btn-update]="!esNuevo">
        {{ esNuevo ? 'üöÄ ENVIAR A COCINA' : '‚úÖ GUARDAR CAMBIOS' }}
      </button>
    </footer>
  </aside>

  <!-- MODAL DE FICHA T√âCNICA (INGREDIENTES) -->
  <div class="modal-overlay" *ngIf="productoSeleccionadoParaInfo" (click)="cerrarInfo()">
    <div class="modal-card info-modal animate-in" (click)="$event.stopPropagation()">
      <header class="modal-header">
        <div class="header-main">
          <h3>Ficha T√©cnica</h3>
          <h2>{{ productoSeleccionadoParaInfo.nombre }}</h2>
        </div>
        <button class="btn-close-modal" (click)="cerrarInfo()">√ó</button>
      </header>

      <div class="modal-content">
        <div class="modal-product-img" *ngIf="productoSeleccionadoParaInfo.imagenUrl">
          <img [src]="productoSeleccionadoParaInfo.imagenUrl" [alt]="productoSeleccionadoParaInfo.nombre">
        </div>

        <div class="ingredientes-section">
          <p class="section-title">Composici√≥n e Ingredientes:</p>
          
          <ul class="ingredientes-list" *ngIf="productoSeleccionadoParaInfo.ingredientes.length; else noIng">
            <li *ngFor="let rel of productoSeleccionadoParaInfo.ingredientes">
              <span class="ing-name">{{ rel.ingrediente?.nombre }}</span>
              <span class="ing-dot"></span>
              <span class="ing-qty">{{ rel.cantidadNecesaria }} {{ rel.ingrediente?.unidad }}</span>
            </li>
          </ul>
          <ng-template #noIng>
            <p class="no-data">No hay ingredientes detallados para este producto.</p>
          </ng-template>
        </div>
      </div>

      <footer class="modal-footer">
        <button class="btn-add-from-info" (click)="agregarProducto(productoSeleccionadoParaInfo); cerrarInfo()">
          üõí A√±adir a Comanda
        </button>
      </footer>
    </div>
  </div>

</div>